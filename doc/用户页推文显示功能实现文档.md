# 用户页推文显示功能实现文档

## 功能概述

在用户个人主页 (`/user/[id]/profile`) 新增了该用户发布的推文列表展示功能，用户可以浏览、点赞、书签、回复和删除（自己的）推文。

## 实现细节

### 前端实现 (pages/user/[id]/profile.vue)

#### 1. 新增的导入

```typescript
import TweetList from '@/components/TweetList.vue';
import TweetCardSkeleton from '@/components/TweetCardSkeleton.vue';
import { useApiFetch } from '@/composables/useApiFetch';
import { Pagination, PaginationContent, ... } from '@/components/ui/pagination';
```

#### 2. 推文列表状态管理

```typescript
const page = ref(1); // 当前页码
const pageSize = ref(10); // 每页显示数量
const fullTweets = ref<any[]>([]); // 完整推文数据
const detailsPending = ref(false); // 详情加载状态
const detailsError = ref<unknown>(null); // 详情错误状态
```

#### 3. API 调用

使用 `useApiFetch` 获取用户推文列表：

```typescript
const {
  data: listApiResponse,
  pending: listPending,
  error: listError
} = useApiFetch<TweetListApiResponse>(
  '/api/v1/tweets/list',
  {
    query: {
      type: 'user', // 指定获取用户推文
      userId: userId, // 目标用户ID
      page: page,
      pageSize: pageSize
    },
    watch: [page] // 监听页码变化
  }
);
```

#### 4. 推文详情获取

通过 `watch` 监听基础推文列表，并获取每条推文的详细信息：

```typescript
watch(listApiResponse, async newListApiResponse => {
  // 1. 获取基础推文列表
  const basicTweets = newListApiResponse.data.tweets;

  // 2. 并发获取所有推文详情
  const detailPromises = basicTweets.map(basicTweet =>
    apiFetch(`/api/v1/tweets/${basicTweet.tweetId}`)
  );

  // 3. 合并基础信息和详情
  fullTweets.value = detailResponses.map(
    (response, index) => ({
      ...response.data.tweet,
      isLikedByUser: basicTweets[index].isLikedByUser,
      isBookmarkedByUser:
        basicTweets[index].isBookmarkedByUser
    })
  );
});
```

#### 5. 推文交互功能

**删除推文**

```typescript
async function handleDeleteTweet(tweetId) {
  const response = await apiFetch(
    `/api/v1/tweets/${tweetId}`,
    {
      method: 'DELETE'
    }
  );
  // 成功后从列表中移除
  fullTweets.value = fullTweets.value.filter(
    t => t.tweetId !== tweetId
  );
}
```

**点赞推文**

```typescript
async function handleLikeTweet(tweet, action) {
  await apiFetch('/api/v1/interactions/like', {
    method: 'POST',
    body: { tweetId: tweet.tweetId, action: action }
  });
  // 更新点赞状态和数量
}
```

**书签推文**

```typescript
async function handleBookmarkTweet(tweet, action) {
  await apiFetch('/api/v1/interactions/bookmark', {
    method: 'POST',
    body: { tweetId: tweet.tweetId, action: action }
  });
  // 更新书签状态
}
```

**回复推文**

```typescript
function handleReplyTweet(tweet) {
  const detailPage = localePath(`/tweet/${tweet.tweetId}`);
  return navigateTo(detailPage);
}
```

#### 6. 分页功能

```typescript
// 计算总页数
const totalPages = computed(() =>
  Math.ceil(totalTweetsCount.value / pageSize.value)
);

// 使用 Pagination 组件
<Pagination
  v-model:page="page"
  :items-per-page="pageSize"
  :total="totalTweetsCount"
/>
```

#### 7. UI 模板结构

```vue
<Card>
  <CardContent class="p-0">
    <!-- 标题 -->
    <div class="p-6 pb-4">
      <h2>推文</h2>
      <p>共 {{ totalTweetsCount }} 条推文</p>
    </div>
    
    <Separator />
    
    <!-- 加载状态 -->
    <div v-if="isLoadingTweets">
      <TweetCardSkeleton v-for="i in 3" :key="i" />
    </div>
    
    <!-- 推文列表 -->
    <TweetList v-else-if="fullTweets.length > 0"
      :tweets="fullTweets"
      @delete-tweet="handleDeleteTweet"
      @reply-tweet="handleReplyTweet"
      @like-tweet="handleLikeTweet"
      @bookmark-tweet="handleBookmarkTweet"
    />
    
    <!-- 空状态 -->
    <div v-else>该用户还没有发布任何推文</div>
    
    <!-- 分页 -->
    <Pagination v-if="totalPages > 1" />
  </CardContent>
</Card>
```

### 后端实现

#### 使用现有接口

后端使用已有的 `/api/v1/tweets/list` 接口，通过 `type='user'` 参数获取指定用户的推文。

**接口路径**: `server/api/v1/tweets/list.get.ts`

**查询参数**:

- `type`: 'user' (指定获取用户推文)
- `userId`: 目标用户ID
- `page`: 页码
- `pageSize`: 每页数量

**SQL 查询** (简化版):

```sql
SELECT v.tweet_id, v.author_id, v.username, v.display_name,
       v.avatar_url, v.likes_count, v.retweets_count, ...
FROM v_comprehensive_timeline v
WHERE v.author_id = :target_user_id
  AND fn_can_view_tweet(:user_id, v.tweet_id) = 1
ORDER BY v.created_at DESC
```

**权限控制**:

- 使用 `fn_can_view_tweet()` 函数检查当前用户是否有权查看该推文
- 支持不同的可见性设置（public, followers, private）

**返回数据**:

```typescript
{
  success: true,
  data: {
    tweets: TweetItem[],  // 推文列表
    totalCount: number    // 总数
  }
}
```

## 功能特点

### 1. 性能优化

- ✅ 使用分页加载，避免一次性加载所有推文
- ✅ 并发获取推文详情，提高加载速度
- ✅ 骨架屏加载状态，提升用户体验

### 2. 交互功能

- ✅ 点赞/取消点赞
- ✅ 书签/取消书签
- ✅ 回复推文（跳转到详情页）
- ✅ 删除推文（仅自己的推文）
- ✅ 转发推文（待实现）

### 3. UI/UX

- ✅ 响应式设计，适配移动端和桌面端
- ✅ 保持与项目整体风格一致
- ✅ 使用现有的 `TweetCard` 和 `TweetList` 组件
- ✅ 分页组件，方便浏览大量推文
- ✅ 空状态提示

### 4. 错误处理

- ✅ 加载失败时显示友好提示
- ✅ 操作失败时显示 Toast 通知
- ✅ 网络错误自动处理

## 测试建议

### 1. 功能测试

- [ ] 访问用户页面，验证推文列表正确显示
- [ ] 测试分页功能，切换页码
- [ ] 测试点赞功能
- [ ] 测试书签功能
- [ ] 测试回复功能（跳转）
- [ ] 测试删除自己的推文
- [ ] 测试空状态（无推文用户）

### 2. 性能测试

- [ ] 测试大量推文的加载性能
- [ ] 测试并发请求的处理
- [ ] 测试页面切换的流畅度

### 3. 边界测试

- [ ] 测试无权限查看的推文
- [ ] 测试已删除的推文
- [ ] 测试网络错误情况

## 使用方法

访问用户主页即可查看该用户的推文：

```
/user/[userId]/profile
```

例如：

```
/user/123/profile
```

## 相关文件

### 前端

- `pages/user/[id]/profile.vue` - 用户主页
- `components/TweetList.vue` - 推文列表组件
- `components/TweetCard.vue` - 推文卡片组件
- `components/TweetCardSkeleton.vue` - 加载骨架屏
- `composables/useApiFetch.ts` - API 请求 hook

### 后端

- `server/api/v1/tweets/list.get.ts` - 推文列表接口
- `server/api/v1/tweets/[tweetId].get.ts` - 推文详情接口
- `server/api/v1/interactions/like.post.ts` - 点赞接口
- `server/api/v1/interactions/bookmark.post.ts` - 书签接口

## 后续优化建议

1. **性能优化**
   - 实现虚拟滚动，提升大列表性能
   - 添加推文缓存机制
   - 优化图片懒加载

2. **功能增强**
   - 添加推文筛选（仅原创、包含回复等）
   - 添加推文搜索
   - 添加推文排序选项

3. **用户体验**
   - 添加下拉刷新
   - 添加无限滚动加载
   - 添加推文预览模态框

## 更新日志

**2025-11-25**

- ✅ 实现用户页推文列表展示
- ✅ 实现推文交互功能（点赞、书签、回复、删除）
- ✅ 实现分页功能
- ✅ 添加加载状态和错误处理
- ✅ 保持风格与项目一致

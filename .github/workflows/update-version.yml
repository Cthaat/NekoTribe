name: è‡ªåŠ¨æ›´æ–°ç‰ˆæœ¬å·

# å½“æŽ¨é€ç‰ˆæœ¬æ ‡ç­¾æ—¶è§¦å‘å·¥ä½œæµ
on:
  push:
    tags:
      - '*/v*.*.*'     # åŒ¹é… user-service/v1.0.0, order-service/v1.2.1 ç­‰æ ¼å¼
      - '*/v*.*.*-*'   # åŒ¹é… payment-service/v3.1.0-beta.1 ç­‰é¢„å‘å¸ƒç‰ˆæœ¬æ ¼å¼

jobs:
  update-version:
    runs-on: ubuntu-latest
    
    steps:
    # 1. æ£€å‡ºä»£ç 
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.NEKO_TOKEN }}

    # 2. è®¾ç½®Node.jsçŽ¯å¢ƒ
    - name: è®¾ç½®Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    # 3. æå–æœåŠ¡åå’Œç‰ˆæœ¬å·
    - name: æå–æœåŠ¡åå’Œç‰ˆæœ¬å·
      id: get_version
      run: |
        # å®Œæ•´æ ‡ç­¾æ ¼å¼ï¼šrefs/tags/service-name/v1.0.0
        FULL_TAG=${GITHUB_REF#refs/tags/}
        echo "å®Œæ•´æ ‡ç­¾: $FULL_TAG"
        
        # æå–æœåŠ¡åï¼ˆæ ‡ç­¾ä¸­'/'å‰çš„éƒ¨åˆ†ï¼‰
        SERVICE_NAME=${FULL_TAG%/v*}
        echo "æœåŠ¡å: $SERVICE_NAME"
        
        # æå–ç‰ˆæœ¬å·ï¼ˆåŽ»æŽ‰æœåŠ¡åå’Œ'v'å‰ç¼€ï¼‰
        VERSION=${FULL_TAG#*/v}
        echo "ç‰ˆæœ¬å·: $VERSION"
        
        # èŽ·å–æ ‡è®°çš„æ³¨é‡Šä¿¡æ¯
        TAG_MESSAGE=$(git tag -l --format='%(contents)' "$FULL_TAG" 2>/dev/null || echo "")
        TAG_SUBJECT=$(git tag -l --format='%(contents:subject)' "$FULL_TAG" 2>/dev/null || echo "")
        TAG_BODY=$(git tag -l --format='%(contents:body)' "$FULL_TAG" 2>/dev/null || echo "")
        
        echo "æ ‡è®°æ³¨é‡Š (å®Œæ•´): $TAG_MESSAGE"
        echo "æ ‡è®°æ ‡é¢˜: $TAG_SUBJECT"
        echo "æ ‡è®°æ­£æ–‡: $TAG_BODY"
        
        # èŽ·å–ä»Žä¸Šä¸ªæ ‡ç­¾åˆ°å½“å‰æ ‡ç­¾çš„æäº¤ä¿¡æ¯
        PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
        if [ -n "$PREVIOUS_TAG" ]; then
          echo "ä¸Šä¸ªæ ‡ç­¾: $PREVIOUS_TAG"
          
          # èŽ·å–ä¸¤ä¸ªæ ‡ç­¾ä¹‹é—´çš„æäº¤ä¿¡æ¯
          COMMIT_RANGE="${PREVIOUS_TAG}..HEAD"
          echo "æäº¤èŒƒå›´: $COMMIT_RANGE"
          
          # èŽ·å–æäº¤æ—¥å¿—ï¼ˆæ ¼å¼åŒ–ï¼‰
          COMMIT_LOG=$(git log --pretty=format:"- %s (%h)" "$COMMIT_RANGE" 2>/dev/null || echo "")
          
          # èŽ·å–æäº¤ç»Ÿè®¡
          COMMIT_COUNT=$(git rev-list --count "$COMMIT_RANGE" 2>/dev/null || echo "0")
          
          # èŽ·å–æ–‡ä»¶å˜æ›´ç»Ÿè®¡
          FILES_CHANGED=$(git diff --name-only "$PREVIOUS_TAG" HEAD | wc -l)
          INSERTIONS=$(git diff --shortstat "$PREVIOUS_TAG" HEAD | grep -o '[0-9]* insertion' | grep -o '[0-9]*' || echo "0")
          DELETIONS=$(git diff --shortstat "$PREVIOUS_TAG" HEAD | grep -o '[0-9]* deletion' | grep -o '[0-9]*' || echo "0")
          
          echo "æäº¤æ•°é‡: $COMMIT_COUNT"
          echo "æ–‡ä»¶å˜æ›´: $FILES_CHANGED"
          echo "æ–°å¢žè¡Œæ•°: $INSERTIONS"
          echo "åˆ é™¤è¡Œæ•°: $DELETIONS"
          
        else
          echo "è¿™æ˜¯ç¬¬ä¸€ä¸ªæ ‡ç­¾ï¼Œæ²¡æœ‰ä¸Šä¸ªæ ‡ç­¾è¿›è¡Œæ¯”è¾ƒ"
          COMMIT_LOG="- ðŸŽ‰ é¡¹ç›®åˆå§‹ç‰ˆæœ¬å‘å¸ƒ"
          COMMIT_COUNT="1"
          FILES_CHANGED="0"
          INSERTIONS="0"
          DELETIONS="0"
        fi
        
        echo "=== æäº¤æ—¥å¿— ==="
        echo "$COMMIT_LOG"
        
        # å¦‚æžœæ ‡è®°æœ‰æ³¨é‡Šï¼Œä½¿ç”¨æ³¨é‡Šä½œä¸ºå‘å¸ƒæ ‡é¢˜ï¼›å¦åˆ™ä½¿ç”¨é»˜è®¤æ ¼å¼
        if [ -n "$TAG_SUBJECT" ]; then
          RELEASE_TITLE="$TAG_SUBJECT"
        else
          RELEASE_TITLE="$SERVICE_NAME v$VERSION"
        fi
        
        echo "å‘å¸ƒæ ‡é¢˜: $RELEASE_TITLE"
        
        # è¾“å‡ºåˆ°GitHub ActionsçŽ¯å¢ƒå˜é‡
        echo "SERVICE_NAME=$SERVICE_NAME" >> $GITHUB_OUTPUT
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "FULL_TAG=$FULL_TAG" >> $GITHUB_OUTPUT
        echo "TAG_MESSAGE=$TAG_MESSAGE" >> $GITHUB_OUTPUT
        echo "TAG_SUBJECT=$TAG_SUBJECT" >> $GITHUB_OUTPUT
        echo "TAG_BODY=$TAG_BODY" >> $GITHUB_OUTPUT
        echo "RELEASE_TITLE=$RELEASE_TITLE" >> $GITHUB_OUTPUT
        echo "COMMIT_LOG=$COMMIT_LOG" >> $GITHUB_OUTPUT
        echo "COMMIT_COUNT=$COMMIT_COUNT" >> $GITHUB_OUTPUT
        echo "FILES_CHANGED=$FILES_CHANGED" >> $GITHUB_OUTPUT
        echo "INSERTIONS=$INSERTIONS" >> $GITHUB_OUTPUT
        echo "DELETIONS=$DELETIONS" >> $GITHUB_OUTPUT
        echo "PREVIOUS_TAG=$PREVIOUS_TAG" >> $GITHUB_OUTPUT
        
        echo "æå–å®Œæˆ - æœåŠ¡: $SERVICE_NAME, ç‰ˆæœ¬: $VERSION, æ ‡é¢˜: $RELEASE_TITLE"

    # 4. æ›´æ–°å¯¹åº”æœåŠ¡çš„ç‰ˆæœ¬ä¿¡æ¯
    - name: æ›´æ–°æœåŠ¡ç‰ˆæœ¬ä¿¡æ¯
      run: |
        SERVICE_NAME="${{ steps.get_version.outputs.SERVICE_NAME }}"
        VERSION="${{ steps.get_version.outputs.VERSION }}"
        FULL_TAG="${{ steps.get_version.outputs.FULL_TAG }}"
        
        echo "å¼€å§‹æ›´æ–°æœåŠ¡ $SERVICE_NAME çš„ç‰ˆæœ¬ä¿¡æ¯åˆ° $VERSION"
        
        # æ›´æ–° .env æ–‡ä»¶ä¸­çš„ç‰ˆæœ¬ä¿¡æ¯
        if [ -f ".env" ]; then
          # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç‰ˆæœ¬ä¿¡æ¯
          if grep -q "PROJECT_VERSION=" .env; then
            # æ›´æ–°çŽ°æœ‰ç‰ˆæœ¬ä¿¡æ¯
            sed -i "s|PROJECT_VERSION=.*|PROJECT_VERSION=$VERSION|g" .env
          else
            # æ·»åŠ æ–°çš„ç‰ˆæœ¬ä¿¡æ¯åˆ°æ–‡ä»¶æœ«å°¾
            echo "" >> .env
            echo "# é¡¹ç›®ç‰ˆæœ¬ä¿¡æ¯" >> .env
            echo "PROJECT_VERSION=$VERSION" >> .env
            echo "PROJECT_SERVICE=$SERVICE_NAME" >> .env
          fi
          
          # åŒæ ·å¤„ç† @version æ³¨é‡Šæ ¼å¼ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
          if grep -q "@version" .env; then
            sed -i "s|@version [0-9]*\.[0-9]*\.[0-9]*|@version $VERSION|g" .env
          fi
          
          echo "å·²æ›´æ–° .env æ–‡ä»¶"
        fi
        
        # æ ¹æ®æœåŠ¡ååˆ›å»ºæˆ–æ›´æ–°ç‰¹å®šçš„ç‰ˆæœ¬é…ç½®æ–‡ä»¶
        VERSION_DIR="config/versions"
        mkdir -p $VERSION_DIR
        
        # åˆ›å»ºæœåŠ¡ç‰ˆæœ¬é…ç½®æ–‡ä»¶
        cat > "$VERSION_DIR/$SERVICE_NAME.json" << 'EOF'
        {
          "serviceName": "SERVICE_NAME_PLACEHOLDER",
          "version": "VERSION_PLACEHOLDER",
          "tag": "FULL_TAG_PLACEHOLDER",
          "releaseDate": "RELEASE_DATE_PLACEHOLDER",
          "buildNumber": "BUILD_NUMBER_PLACEHOLDER"
        }
        EOF
        
        # æ›¿æ¢å ä½ç¬¦ - ä½¿ç”¨ä¸åŒçš„åˆ†éš”ç¬¦é¿å…ç‰¹æ®Šå­—ç¬¦é—®é¢˜
        sed -i "s|SERVICE_NAME_PLACEHOLDER|$SERVICE_NAME|g" "$VERSION_DIR/$SERVICE_NAME.json"
        sed -i "s|VERSION_PLACEHOLDER|$VERSION|g" "$VERSION_DIR/$SERVICE_NAME.json"
        sed -i "s|FULL_TAG_PLACEHOLDER|$FULL_TAG|g" "$VERSION_DIR/$SERVICE_NAME.json"
        sed -i "s|RELEASE_DATE_PLACEHOLDER|$(date -u +%Y-%m-%dT%H:%M:%SZ)|g" "$VERSION_DIR/$SERVICE_NAME.json"
        sed -i "s|BUILD_NUMBER_PLACEHOLDER|$GITHUB_RUN_NUMBER|g" "$VERSION_DIR/$SERVICE_NAME.json"
        
        echo "å·²åˆ›å»º/æ›´æ–°æœåŠ¡ç‰ˆæœ¬é…ç½®: $VERSION_DIR/$SERVICE_NAME.json"
        
        # æ˜¾ç¤ºæ›´æ–°å†…å®¹
        echo "=== ç‰ˆæœ¬æ›´æ–°å†…å®¹ ==="
        if [ -f ".env" ]; then
          echo "--- .env æ–‡ä»¶ç‰ˆæœ¬ä¿¡æ¯ ---"
          cat .env | grep -E "(version:|@version)" | head -5
        fi
        echo "--- æœåŠ¡ç‰ˆæœ¬é…ç½® ---"
        cat "$VERSION_DIR/$SERVICE_NAME.json"

    # 5. å®‰è£…ä¾èµ–ï¼ˆå¦‚æžœéœ€è¦ï¼‰
    - name: å®‰è£…ä¾èµ–
      run: |
        if [ -f package.json ]; then
          npm install
        fi

    # 6. æ›´æ–°README.mdç‰ˆæœ¬ä¿¡æ¯
    - name: æ›´æ–°README.mdç‰ˆæœ¬ä¿¡æ¯
      run: |
        SERVICE_NAME="${{ steps.get_version.outputs.SERVICE_NAME }}"
        VERSION="${{ steps.get_version.outputs.VERSION }}"
        
        echo "æ›´æ–° README.md ä¸­ $SERVICE_NAME æœåŠ¡çš„ç‰ˆæœ¬ä¿¡æ¯"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰ä¸“é—¨çš„READMEæ›´æ–°è„šæœ¬
        if [ -f "scripts/update-readme-version.js" ]; then
          cd scripts
          # ä¼ é€’æœåŠ¡åå’Œç‰ˆæœ¬å·ç»™è„šæœ¬
          SERVICE_NAME="$SERVICE_NAME" VERSION="$VERSION" node update-readme-version.js
          echo "ä½¿ç”¨è„šæœ¬æ›´æ–° README.md å®Œæˆ"
        else
          # ä½¿ç”¨sedç›´æŽ¥æ›´æ–°READMEä¸­çš„ç‰ˆæœ¬å¾½ç«  - ä½¿ç”¨ä¸åŒåˆ†éš”ç¬¦é¿å…ç‰¹æ®Šå­—ç¬¦é—®é¢˜
          if [ -f "README.md" ]; then
            # æ›´æ–°æœåŠ¡ç‰¹å®šçš„ç‰ˆæœ¬å¾½ç« 
            sed -i "s|!\[${SERVICE_NAME}-version\]\[.*\]|!\[${SERVICE_NAME}-version\](https://img.shields.io/badge/${SERVICE_NAME}-v${VERSION}-blue)|g" README.md
            
            # æ›´æ–°é€šç”¨ç‰ˆæœ¬å¾½ç« ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
            sed -i "s|!\[version\]\[.*v[0-9]*\.[0-9]*\.[0-9]*.*\]|!\[version\](https://img.shields.io/badge/version-v${VERSION}-blue)|g" README.md
            
            echo "ç›´æŽ¥æ›´æ–° README.md ç‰ˆæœ¬å¾½ç« å®Œæˆ"
          fi
        fi

    # 7. æäº¤æ›´æ”¹
    - name: æäº¤ç‰ˆæœ¬æ›´æ–°
      run: |
        SERVICE_NAME="${{ steps.get_version.outputs.SERVICE_NAME }}"
        VERSION="${{ steps.get_version.outputs.VERSION }}"
        
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # æ·»åŠ æ›´æ”¹çš„æ–‡ä»¶
        git add .env README.md config/versions/
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹éœ€è¦æäº¤
        if git diff --staged --quiet; then
          echo "æ²¡æœ‰æ–‡ä»¶éœ€è¦æäº¤"
        else
          git commit -m "ðŸ”– è‡ªåŠ¨æ›´æ–° $SERVICE_NAME ç‰ˆæœ¬å·åˆ° v$VERSION"
          
          # æŽ¨é€åˆ°ä¸»åˆ†æ”¯
          git push origin HEAD:master
          
          echo "ç‰ˆæœ¬æ›´æ–°å·²æäº¤å¹¶æŽ¨é€"
        fi

    # 8. åˆ›å»ºGitHub Releaseï¼ˆå¯é€‰ï¼‰
    - name: åˆ›å»ºGitHub Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.NEKO_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: ${{ steps.get_version.outputs.RELEASE_TITLE }}
        body: |
          ## ðŸŽ‰ ${{ steps.get_version.outputs.SERVICE_NAME }} ç‰ˆæœ¬ v${{ steps.get_version.outputs.VERSION }} å‘å¸ƒ

          ### ðŸ“‹ å‘å¸ƒä¿¡æ¯
          - ðŸ·ï¸ **æœåŠ¡åç§°**: ${{ steps.get_version.outputs.SERVICE_NAME }}
          - ðŸ“Œ **ç‰ˆæœ¬å·**: v${{ steps.get_version.outputs.VERSION }}
          - ðŸ”– **å®Œæ•´æ ‡ç­¾**: ${{ steps.get_version.outputs.FULL_TAG }}
          - ðŸ—ï¸ **æž„å»ºç¼–å·**: ${{ github.run_number }}
          ${{ steps.get_version.outputs.PREVIOUS_TAG && format('- ðŸ“Š **ä¸Šä¸ªç‰ˆæœ¬**: {0}', steps.get_version.outputs.PREVIOUS_TAG) || '' }}

          ### ðŸ·ï¸ å˜æ›´ç»Ÿè®¡
          - ðŸ”– **æäº¤æ•°é‡**: ${{ steps.get_version.outputs.COMMIT_COUNT }} ä¸ªæäº¤
          - ðŸ“ **æ–‡ä»¶å˜æ›´**: ${{ steps.get_version.outputs.FILES_CHANGED }} ä¸ªæ–‡ä»¶
          - âž• **æ–°å¢žä»£ç **: ${{ steps.get_version.outputs.INSERTIONS }} è¡Œ
          - âž– **åˆ é™¤ä»£ç **: ${{ steps.get_version.outputs.DELETIONS }} è¡Œ

          ### ðŸ”„ è‡ªåŠ¨æ›´æ–°å†…å®¹
          - âœ… æ›´æ–° `.env` ç‰ˆæœ¬å·
          - âœ… æ›´æ–° `README.md` ç‰ˆæœ¬å¾½ç« 
          - âœ… åˆ›å»ºæœåŠ¡ç‰ˆæœ¬é…ç½®æ–‡ä»¶
          - âœ… åŒæ­¥æ‰€æœ‰ç‰ˆæœ¬ä¿¡æ¯

          ### ðŸš€ æäº¤è®°å½•
          ${{ steps.get_version.outputs.COMMIT_LOG }}

          ### ï¿½ æ ‡ç­¾è¯´æ˜Ž
          ${{ steps.get_version.outputs.TAG_MESSAGE || 'æ— é¢å¤–è¯´æ˜Ž' }}

          ---
          *æ­¤ç‰ˆæœ¬ç”± GitHub Actions è‡ªåŠ¨å‘å¸ƒ*
        draft: false
        prerelease: ${{ contains(steps.get_version.outputs.VERSION, 'beta') || contains(steps.get_version.outputs.VERSION, 'alpha') || contains(steps.get_version.outputs.VERSION, 'rc') }}

    # 9. é€šçŸ¥å®ŒæˆçŠ¶æ€
    - name: è¾“å‡ºå®Œæˆä¿¡æ¯
      run: |
        SERVICE_NAME="${{ steps.get_version.outputs.SERVICE_NAME }}"
        VERSION="${{ steps.get_version.outputs.VERSION }}"
        FULL_TAG="${{ steps.get_version.outputs.FULL_TAG }}"
        COMMIT_COUNT="${{ steps.get_version.outputs.COMMIT_COUNT }}"
        FILES_CHANGED="${{ steps.get_version.outputs.FILES_CHANGED }}"
        PREVIOUS_TAG="${{ steps.get_version.outputs.PREVIOUS_TAG }}"
        
        echo "ðŸŽ‰ $SERVICE_NAME æœåŠ¡ç‰ˆæœ¬æ›´æ–°å·¥ä½œæµå®Œæˆï¼"
        echo "ðŸ“Œ æœåŠ¡åç§°: $SERVICE_NAME"
        echo "ðŸ“Œ ç‰ˆæœ¬å·: v$VERSION"
        echo "ðŸ·ï¸ å®Œæ•´æ ‡ç­¾: $FULL_TAG"
        
        if [ -n "$PREVIOUS_TAG" ]; then
          echo "ðŸ“Š ç‰ˆæœ¬å¯¹æ¯”: $PREVIOUS_TAG â†’ $FULL_TAG"
          echo "ðŸ”„ æäº¤æ•°é‡: $COMMIT_COUNT ä¸ª"
          echo "ðŸ“ æ–‡ä»¶å˜æ›´: $FILES_CHANGED ä¸ª"
        else
          echo "ðŸŽ‰ è¿™æ˜¯é¦–æ¬¡å‘å¸ƒï¼"
        fi
        
        echo "ðŸ“ æ›´æ–°çš„æ–‡ä»¶:"
        echo "   - .env (é€šç”¨ç‰ˆæœ¬ä¿¡æ¯)"
        echo "   - README.md (ç‰ˆæœ¬å¾½ç« )"
        echo "   - config/versions/$SERVICE_NAME.json (æœåŠ¡ç‰ˆæœ¬é…ç½®)"
        echo "ðŸš€ GitHub Release å·²åˆ›å»º"
        
        # æ˜¾ç¤ºç‰ˆæœ¬å‘å¸ƒç±»åž‹
        if [[ "$VERSION" == *"beta"* ]] || [[ "$VERSION" == *"alpha"* ]] || [[ "$VERSION" == *"rc"* ]]; then
          echo "âš ï¸ è¿™æ˜¯ä¸€ä¸ªé¢„å‘å¸ƒç‰ˆæœ¬"
        else
          echo "âœ… è¿™æ˜¯ä¸€ä¸ªæ­£å¼å‘å¸ƒç‰ˆæœ¬"
        fi